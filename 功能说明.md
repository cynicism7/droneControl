# 无人机集群协同数据采集与图像融合系统 - 功能说明

## 已实现的功能

### 1. ✅ 先飞到起点并悬停，然后同时开始运动和拍摄

**实现位置**: `main.py` 第4.5节

**功能说明**:
- 所有无人机先飞到各自矩形路径的起点
- 等待所有无人机到达起点并悬停
- 确保所有无人机同时开始扫描，保证图像对齐

**关键代码**:
```python
# 所有无人机先飞到各自路径起点并悬停
start_positions = {}
for drone in drones:
    planner = planners[drone.name]
    start_pos = planner.get_start_waypoint()
    start_positions[drone.name] = start_pos
    drone.move_to_position(start_pos, velocity=2.0)
```

### 2. ✅ 点云数据采集功能

**实现位置**: `swarm/drone.py` 的 `capture_pointcloud()` 方法

**功能说明**:
- 使用深度相机生成点云数据
- 将点云数据保存为PLY格式文件
- 点云数据包含位置、姿态和时间戳信息
- 点云采集间隔：每3秒一次

**数据格式**:
- 文件格式：PLY (ASCII)
- 存储位置：`pointclouds_Drone1/`, `pointclouds_Drone2/`, `pointclouds_Drone3/`
- 数据包含：3D坐标点 (x, y, z)

### 3. ✅ 摄像机朝向调整

**实现位置**: `swarm/drone.py` 的 `set_camera_orientation()` 方法

**功能说明**:
- 默认设置：向下倾斜45度（pitch=-45°）
- 便于拍摄地面场景，提高图像融合质量
- 可在运行时动态调整

**当前配置**:
```python
d.set_camera_orientation(pitch=-45, yaw=0, roll=0)
```

### 4. ✅ UDP通信模块

**实现位置**: `swarm/udp_communication.py`

**功能说明**:
- 实现了完整的UDP通信模块
- 支持数据发送和接收
- 支持广播同步信号
- 端口配置：
  - 头机（Drone1）：9001
  - 跟随者1（Drone2）：9002
  - 跟随者2（Drone3）：9003

**主要功能**:
- `send_to_leader()`: 发送数据到头机
- `broadcast_sync()`: 广播同步信号
- `register_handler()`: 注册消息处理器
- 自动接收循环（多线程）

**使用方式**:
```python
udp_comm = UDPCommunication("Drone1", 9001)
udp_comm.start()
udp_comm.send_to_leader(data)
udp_comm.broadcast_sync(timestamp)
```

### 5. ✅ 时序同步机制

**实现位置**: `main.py` 第4.6节

**功能说明**:
- 头机广播同步时间戳
- 所有无人机使用相对时间进行数据采集
- 确保图像和点云数据的时间对齐
- 支持UDP同步和简单时间同步两种模式

**同步流程**:
1. 头机生成同步时间戳
2. 通过UDP广播同步信号（如果UDP可用）
3. 所有无人机记录同步时间
4. 后续采集使用相对时间：`sync_relative_time = current_time - sync_timestamp`

**日志输出**:
```
[同步] 头机广播同步信号，时间戳: 1234567890.123
[采集] Drone1 在位置 [x, y] 采集图像 (同步时间: 2.35s)
```

## 系统工作流程

1. **初始化阶段**
   - 创建三架无人机
   - 初始化通信网络（模拟通信 + UDP通信）
   - 设置摄像机朝向（向下45度）

2. **起飞阶段**
   - 所有无人机起飞到目标高度
   - 等待稳定

3. **路径规划阶段**
   - 为每架无人机规划独立的矩形路径
   - 计算路径起点

4. **移动到起点阶段**
   - 所有无人机飞到各自路径起点
   - 等待所有无人机到达并悬停

5. **同步开始阶段**
   - 头机广播同步信号
   - 所有无人机同时开始扫描

6. **数据采集阶段**
   - 图像采集：每2秒一次
   - 点云采集：每3秒一次
   - 数据通过UDP和模拟通信双重传输

7. **数据融合阶段**
   - 收集所有图像数据
   - 执行图像融合（特征匹配、配准、融合）
   - 生成全景图像

8. **返航降落阶段**
   - 所有无人机异步返航
   - 所有无人机异步降落

## 数据输出

### 图像数据
- **原始图像**: `images_Drone1/`, `images_Drone2/`, `images_Drone3/`
- **融合结果**: `fusion_results/fused_result.png`
- **格式**: PNG

### 点云数据
- **点云文件**: `pointclouds_Drone1/`, `pointclouds_Drone2/`, `pointclouds_Drone3/`
- **格式**: PLY (ASCII)
- **内容**: 3D坐标点 (x, y, z)

## 通信架构

### 双重通信机制
1. **UDP通信**（真实网络通信）
   - 用于实际部署
   - 支持网络延迟和丢包处理
   - 支持时序同步

2. **模拟通信**（备用机制）
   - 用于仿真环境
   - 直接内存传输
   - 确保数据不丢失

### 通信流程
```
跟随者无人机 → UDP发送 → 头机接收
            ↓
        模拟通信（备用）
```

## 时序同步说明

### 同步精度
- UDP同步：网络延迟 < 10ms（局域网）
- 时间同步：系统时钟精度

### 同步流程
1. 头机生成基准时间戳 `sync_timestamp`
2. 通过UDP广播给所有跟随者
3. 所有无人机记录同步时间
4. 后续采集使用相对时间

### 时间戳格式
- 绝对时间戳：`time.time()` (Unix时间戳)
- 相对时间戳：`current_time - sync_timestamp` (秒)

## 配置参数

### 路径规划参数
- 矩形尺寸：20m × 20m
- 飞行速度：2.0 m/s
- 飞行高度：10m（可配置）

### 数据采集参数
- 图像采集间隔：2.0秒
- 点云采集间隔：3.0秒
- 摄像机俯仰角：-45度

### 通信参数
- 头机UDP端口：9001
- 跟随者1端口：9002
- 跟随者2端口：9003

## 注意事项

1. **UDP通信**：如果UDP启动失败，系统会自动使用模拟通信
2. **点云生成**：使用深度图像生成点云，需要深度相机配置
3. **摄像机朝向**：需要在settings.json中配置gimbal支持（可选）
4. **时序同步**：确保所有无人机系统时钟同步（NTP）

## 未来改进方向

1. 实现点云融合功能
2. 优化图像融合算法，提高全景图像质量
3. 添加网络延迟补偿机制
4. 实现更精确的时序同步（PTP协议）
5. 添加数据压缩和加密功能
